pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                // checkout project repo
                dir('workdir') {
                    git url: "${env.PROJECT_REPOSITORY_URL}",
                            branch: "${env.PROJECT_REPOSITORY_BRANCH}"
                }
                // checkout configuration repo
                dir('configs') {
                    git url: "${env.CONFIG_REPOSITORY_URL}",
                            branch: "${env.CONFIG_REPOSITORY_BRANCH}"
                }
                // download dependency updater binary
                script {
                    def binaryVersion = env.BINARY_VERSION ?: '1.0.1'
                    def binaryUrl = "https://repository.jboss.org/nexus/service/local/repositories/releases/content/org/jboss/set/dependency-alignment/cli/${binaryVersion}/cli-${binaryVersion}.jar"
                    def binaryPath = "alignment-cli-${binaryVersion}.jar"
                    def binaryFile = new File(env.WORKSPACE, binaryPath)
                    println('Checking existence of ' + binaryFile.getAbsolutePath())
                    if (!binaryFile.exists()) {
                        println("Downloading ${binaryPath}")
                        binaryFile.createNewFile()
                        binaryFile.newDataOutputStream().write(new URL(binaryUrl).getBytes())
                        //binaryFile << new URL(binaryUrl).getBytes()
                    }
                    env.BINARY_PATH = binaryPath
                }
            }
        }
        stage ('Run Report') {
            steps {
                // run the CLI tool
                sh script: """
                    java -Dlogger.projectCode='${env.LOGGER_CODE}' \\
                         -Dlogger.uri='${env.LOGGER_URI}' \\
                         -jar '${env.BINARY_PATH}' send-html-report \\
                         -c 'configs/${env.CONFIG_FILE}' \\
                         -f 'workdir/pom.xml' \\
                         --email-smtp-host 'smtp.corp.redhat.com' \\
                         --email-smtp-port '587' \\
                         --email-subject '${env.SUBJECT}' \\
                         --email-from '${env.FROM_ADDR}' \\
                         --email-to '${env.TO_ADDR}'
                    """
            }
        }
    }
}
